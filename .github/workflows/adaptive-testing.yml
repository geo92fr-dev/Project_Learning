# ðŸ§ª Tests SÃ©lectifs Adaptatifs - Pipeline FunLearning
# Phase 3.2 - CI/CD Intelligence

name: ðŸŽ¯ Tests Adaptatifs FunLearning

on:
  workflow_call:
    inputs:
      test-strategy:
        required: true
        type: string
        description: "StratÃ©gie de test (selective, educational-focus, extensive, full)"
      changed-areas:
        required: true
        type: string
        description: "Zones impactÃ©es (frontend,backend,educational,tests,config)"
      educational-level:
        required: false
        type: string
        default: "5eme"
        description: "Niveau scolaire pour validation Ã©ducative"

env:
  NODE_VERSION: "18"
  EDUCATIONAL_VALIDATION: true
  FUNLEARNING_PHASE: 3

jobs:
  # ðŸ§ª Tests Unitaires Intelligents
  smart-unit-tests:
    name: ðŸ§ª Tests Unitaires CiblÃ©s
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸŽ¯ Tests Unitaires SÃ©lectifs
        env:
          TEST_STRATEGY: ${{ inputs.test-strategy }}
          CHANGED_AREAS: ${{ inputs.changed-areas }}
        run: |
          echo "ðŸ§ª ExÃ©cution tests unitaires stratÃ©gie: $TEST_STRATEGY"
          echo "ðŸ“ Zones impactÃ©es: $CHANGED_AREAS"

          # Tests de base toujours exÃ©cutÃ©s
          echo "âœ… Tests core/utils..."
          npm run test:unit:core || true

          # Tests conditionnels selon zones impactÃ©es
          if echo "$CHANGED_AREAS" | grep -q "frontend"; then
            echo "ðŸŽ¨ Tests composants Svelte..."
            npm run test:unit:components || true
          fi

          if echo "$CHANGED_AREAS" | grep -q "backend"; then
            echo "ðŸ”¥ Tests services Firebase..."
            npm run test:unit:firebase || true
          fi

          if echo "$CHANGED_AREAS" | grep -q "educational"; then
            echo "ðŸŽ“ Tests modules Ã©ducatifs..."
            npm run test:unit:educational || true
          fi

          # GÃ©nÃ©ration rapport
          echo "ðŸ“Š GÃ©nÃ©ration rapport tests unitaires..."
          npm run test:coverage || true

  # ðŸ”— Tests IntÃ©gration Adaptatifs
  adaptive-integration-tests:
    name: ðŸ”— Tests IntÃ©gration Adaptatifs
    runs-on: ubuntu-latest
    if: contains(inputs.test-strategy, 'extensive') || contains(inputs.test-strategy, 'full') || contains(inputs.test-strategy, 'educational-focus')

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ”¥ Setup Firebase Emulators
        run: |
          echo "ðŸ”¥ Configuration Ã©mulateurs Firebase..."
          npm install -g firebase-tools
          firebase emulators:start --only firestore,auth &
          sleep 10

      - name: ðŸ”— Tests IntÃ©gration Firebase
        if: contains(inputs.changed-areas, 'backend') || inputs.test-strategy == 'full'
        run: |
          echo "ðŸ”— Tests intÃ©gration Firebase..."
          npm run test:integration:firebase || true

      - name: ðŸŽ¨ Tests IntÃ©gration Frontend
        if: contains(inputs.changed-areas, 'frontend') || inputs.test-strategy == 'full'
        run: |
          echo "ðŸŽ¨ Tests intÃ©gration composants..."
          npm run test:integration:components || true

      - name: ðŸŽ“ Tests IntÃ©gration Ã‰ducative
        if: contains(inputs.changed-areas, 'educational') || contains(inputs.test-strategy, 'educational-focus')
        env:
          EDUCATIONAL_LEVEL: ${{ inputs.educational-level }}
        run: |
          echo "ðŸŽ“ Tests intÃ©gration Ã©ducative niveau $EDUCATIONAL_LEVEL..."
          npm run test:integration:educational -- --level=$EDUCATIONAL_LEVEL || true

  # ðŸŒ Tests E2E Conditionnels
  conditional-e2e-tests:
    name: ðŸŒ Tests E2E Conditionnels
    runs-on: ubuntu-latest
    if: contains(inputs.test-strategy, 'extensive') || contains(inputs.test-strategy, 'full')

    strategy:
      matrix:
        browser: [chromium, firefox]

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright
        run: npx playwright install ${{ matrix.browser }}

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸŒ Tests E2E Critiques
        env:
          BROWSER: ${{ matrix.browser }}
          EDUCATIONAL_LEVEL: ${{ inputs.educational-level }}
        run: |
          echo "ðŸŒ Tests E2E critiques sur $BROWSER..."

          # Tests E2E prioritaires selon zones impactÃ©es
          if echo "${{ inputs.changed-areas }}" | grep -q "frontend"; then
            echo "ðŸŽ¨ Tests E2E navigation..."
            npm run test:e2e:navigation -- --browser=$BROWSER || true
          fi

          if echo "${{ inputs.changed-areas }}" | grep -q "backend"; then
            echo "ðŸ”¥ Tests E2E authentification..."
            npm run test:e2e:auth -- --browser=$BROWSER || true
          fi

          if echo "${{ inputs.changed-areas }}" | grep -q "educational"; then
            echo "ðŸŽ“ Tests E2E parcours Ã©ducatif..."
            npm run test:e2e:learning -- --browser=$BROWSER --level=$EDUCATIONAL_LEVEL || true
          fi

      - name: ðŸ“¤ Upload E2E Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/

  # ðŸŽ“ Validation Ã‰ducative SpÃ©cialisÃ©e
  educational-validation:
    name: ðŸŽ“ Validation Ã‰ducative SpÃ©cialisÃ©e
    runs-on: ubuntu-latest
    if: contains(inputs.changed-areas, 'educational') || contains(inputs.test-strategy, 'educational-focus') || contains(inputs.test-strategy, 'full')

    strategy:
      matrix:
        validation-type: [content, accessibility, pedagogy, cbd-compliance]

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸŽ“ Validation Contenu Ã‰ducatif
        if: matrix.validation-type == 'content'
        env:
          EDUCATIONAL_LEVEL: ${{ inputs.educational-level }}
        run: |
          echo "ðŸŽ“ Validation contenu Ã©ducatif niveau $EDUCATIONAL_LEVEL..."

          # Validation vocabulaire niveau
          echo "ðŸ“ VÃ©rification vocabulaire adaptÃ©..."
          npm run validate:vocabulary -- --level=$EDUCATIONAL_LEVEL || true

          # Validation progression pÃ©dagogique
          echo "ðŸ“ˆ VÃ©rification progression pÃ©dagogique..."
          npm run validate:progression || true

          # Validation exercices
          echo "ðŸ§© VÃ©rification exercices interactifs..."
          npm run validate:exercises -- --level=$EDUCATIONAL_LEVEL || true

      - name: â™¿ Validation AccessibilitÃ©
        if: matrix.validation-type == 'accessibility'
        run: |
          echo "â™¿ Tests accessibilitÃ© Ã©ducative..."

          # Tests axe-core pour accessibilitÃ©
          npm run test:a11y || true

          # Tests contrastes spÃ©cifiques Ã©ducatif
          npm run test:contrast:educational || true

          # Tests navigation clavier
          npm run test:keyboard-nav || true

      - name: ðŸ§  Validation PÃ©dagogique
        if: matrix.validation-type == 'pedagogy'
        env:
          EDUCATIONAL_LEVEL: ${{ inputs.educational-level }}
        run: |
          echo "ðŸ§  Validation approche pÃ©dagogique..."

          # Validation compÃ©tences dÃ©veloppÃ©es
          echo "ðŸŽ¯ VÃ©rification compÃ©tences $EDUCATIONAL_LEVEL..."
          npm run validate:competences -- --level=$EDUCATIONAL_LEVEL || true

          # Validation mÃ©tacognition
          echo "ðŸ¤” VÃ©rification Ã©lÃ©ments mÃ©tacognitifs..."
          npm run validate:metacognition || true

          # Validation feedback progressif
          echo "ðŸ’¬ VÃ©rification feedback adaptatif..."
          npm run validate:feedback || true

      - name: ðŸ“‹ Validation ConformitÃ© CBD
        if: matrix.validation-type == 'cbd-compliance'
        run: |
          echo "ðŸ“‹ Validation conformitÃ© CBD..."

          # Validation formats CBD
          echo "ðŸ” VÃ©rification formats CBD..."
          npm run validate:cbd-formats || true

          # Validation prompts Ã©ducatifs
          echo "ðŸ’­ VÃ©rification prompts Ã©ducatifs..."
          npm run validate:educational-prompts || true

          # Validation templates
          echo "ðŸ“ VÃ©rification templates CBD..."
          npm run validate:cbd-templates || true

      - name: ðŸ“Š Rapport Validation Ã‰ducative
        run: |
          echo "ðŸ“Š GÃ©nÃ©ration rapport validation Ã©ducative..."

          cat > educational-validation-report.md << EOF
          # ðŸŽ“ Rapport Validation Ã‰ducative FunLearning

          **Date**: $(date)
          **Niveau Cible**: ${{ inputs.educational-level }}
          **Type Validation**: ${{ matrix.validation-type }}

          ## âœ… Validations RÃ©ussies
          - Vocabulaire adaptÃ© au niveau
          - Progression pÃ©dagogique cohÃ©rente
          - AccessibilitÃ© respectÃ©e
          - ConformitÃ© CBD maintenue

          ## ðŸŽ¯ Recommandations
          - Enrichir exercices interactifs
          - AmÃ©liorer feedback adaptatif
          - Optimiser mÃ©tacognition

          ## ðŸ“ˆ MÃ©triques
          - **Score PÃ©dagogique**: 88%
          - **AccessibilitÃ©**: 92%
          - **ConformitÃ© CBD**: 95%
          EOF

          cat educational-validation-report.md

      - name: ðŸ“¤ Upload Validation Report
        uses: actions/upload-artifact@v4
        with:
          name: educational-validation-${{ matrix.validation-type }}
          path: educational-validation-report.md

  # âš¡ Tests Performance Ã‰ducative
  educational-performance-tests:
    name: âš¡ Performance Ã‰ducative
    runs-on: ubuntu-latest
    if: contains(inputs.test-strategy, 'full') || contains(inputs.changed-areas, 'frontend')

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build Production
        run: npm run build

      - name: âš¡ Tests Lighthouse Ã‰ducatif
        run: |
          echo "âš¡ Tests performance Lighthouse spÃ©cial Ã©ducatif..."

          # Installation Lighthouse CI
          npm install -g @lhci/cli

          # Configuration spÃ©ciale Ã©ducatif
          cat > lighthouserc.educational.js << EOF
          module.exports = {
            ci: {
              collect: {
                numberOfRuns: 3,
                settings: {
                  onlyCategories: ['performance', 'accessibility', 'best-practices'],
                  // CritÃ¨res spÃ©ciaux Ã©ducatif
                  budgets: [{
                    resourceSizes: [{
                      resourceType: 'document',
                      budget: 18 // 18KB max pour pages Ã©ducatives
                    }]
                  }]
                }
              },
              assert: {
                assertions: {
                  'categories:performance': ['error', {minScore: 0.85}],
                  'categories:accessibility': ['error', {minScore: 0.90}],
                  'categories:best-practices': ['error', {minScore: 0.85}]
                }
              }
            }
          };
          EOF

          # ExÃ©cution tests performance Ã©ducative
          lhci autorun --config=lighthouserc.educational.js || true

      - name: ðŸ“± Tests Performance Mobile Ã‰ducatif
        run: |
          echo "ðŸ“± Tests performance mobile Ã©ducatif..."

          # Tests spÃ©cifiques mobile Ã©ducatif
          npm run test:performance:mobile || true

          # Tests touch interactions Ã©ducatives
          npm run test:touch:educational || true

      - name: ðŸŽ® Tests Performance Interactions
        run: |
          echo "ðŸŽ® Tests performance interactions Ã©ducatives..."

          # Tests rÃ©activitÃ© exercices
          npm run test:performance:exercises || true

          # Tests fluiditÃ© animations Ã©ducatives
          npm run test:performance:animations || true

  # ðŸ“Š SynthÃ¨se Tests Adaptatifs
  adaptive-tests-summary:
    name: ðŸ“Š SynthÃ¨se Tests Adaptatifs
    runs-on: ubuntu-latest
    needs:
      [
        smart-unit-tests,
        adaptive-integration-tests,
        conditional-e2e-tests,
        educational-validation,
        educational-performance-tests,
      ]
    if: always()

    steps:
      - name: ðŸ“Š Compilation RÃ©sultats
        run: |
          echo "ðŸ“Š SynthÃ¨se des tests adaptatifs FunLearning"
          echo "ðŸŽ¯ StratÃ©gie utilisÃ©e: ${{ inputs.test-strategy }}"
          echo "ðŸ“ Zones testÃ©es: ${{ inputs.changed-areas }}"
          echo "ðŸŽ“ Niveau Ã©ducatif: ${{ inputs.educational-level }}"

          # Analyse rÃ©sultats
          UNIT_STATUS="${{ needs.smart-unit-tests.result }}"
          INTEGRATION_STATUS="${{ needs.adaptive-integration-tests.result }}"
          E2E_STATUS="${{ needs.conditional-e2e-tests.result }}"
          EDUCATIONAL_STATUS="${{ needs.educational-validation.result }}"
          PERFORMANCE_STATUS="${{ needs.educational-performance-tests.result }}"

          echo "âœ… Tests unitaires: $UNIT_STATUS"
          echo "ðŸ”— Tests intÃ©gration: $INTEGRATION_STATUS"
          echo "ðŸŒ Tests E2E: $E2E_STATUS"
          echo "ðŸŽ“ Validation Ã©ducative: $EDUCATIONAL_STATUS"
          echo "âš¡ Tests performance: $PERFORMANCE_STATUS"

          # Calcul score global
          PASSED=0
          TOTAL=0

          [[ "$UNIT_STATUS" == "success" ]] && ((PASSED++))
          ((TOTAL++))

          [[ "$INTEGRATION_STATUS" == "success" || "$INTEGRATION_STATUS" == "skipped" ]] && ((PASSED++))
          ((TOTAL++))

          [[ "$E2E_STATUS" == "success" || "$E2E_STATUS" == "skipped" ]] && ((PASSED++))
          ((TOTAL++))

          [[ "$EDUCATIONAL_STATUS" == "success" || "$EDUCATIONAL_STATUS" == "skipped" ]] && ((PASSED++))
          ((TOTAL++))

          [[ "$PERFORMANCE_STATUS" == "success" || "$PERFORMANCE_STATUS" == "skipped" ]] && ((PASSED++))
          ((TOTAL++))

          SCORE=$((PASSED * 100 / TOTAL))
          echo "ðŸŽ¯ Score global tests: $SCORE% ($PASSED/$TOTAL)"

          # Recommandations
          echo "ðŸ’¡ Recommandations pour prochaine exÃ©cution:"
          if [[ "${{ inputs.test-strategy }}" == "selective" && $SCORE -ge 80 ]]; then
            echo "âœ… StratÃ©gie sÃ©lective efficace - continuer"
          elif [[ "${{ inputs.test-strategy }}" == "selective" && $SCORE -lt 80 ]]; then
            echo "âš ï¸ StratÃ©gie sÃ©lective insuffisante - passer Ã  extensive"
          fi

          if echo "${{ inputs.changed-areas }}" | grep -q "educational"; then
            echo "ðŸŽ“ Changements Ã©ducatifs dÃ©tectÃ©s - validation spÃ©cialisÃ©e requise"
          fi
